# Results


TODO 
time series + 改成柱状图& +growth rate 


```{r stations, include=FALSE}
library(tidyverse)
library(rvest)
library(robotstxt)
library(pander)
library(readxl)
#paths_allowed("https://data.ny.gov/api/views/7rrd-248n/rows.csv?accessType=DOWNLOAD&sorting=true")
stations <-read.csv("https://data.ny.gov/api/views/7rrd-248n/rows.csv?accessType=DOWNLOAD&sorting=true")
registration_url<-"https://www.nyserda.ny.gov/-/media/Files/Programs/ChargeNY/EV-Registration-Tables.xlsx"
temp <-tempfile(fileext = ".xlsx")
download.file(registration_url, destfile=temp, mode='wb')
registration_utility <- readxl::read_excel(temp, sheet =1)
registration_zipcode <- readxl::read_excel(temp, sheet =2)
registration_model <- readxl::read_excel(temp, sheet =3)
registration_county <- readxl::read_excel(temp, sheet =4)
registration_originaltime <- readxl::read_excel(temp, sheet =5)
registration_originalmake <- readxl::read_excel(temp, sheet =6)

```




<p style="font-size:23px;"> EV Charging Stations Info </p>
```{r}
## drop 3 columns with only NA values, will drop more irrelevant columns. Fuel Type Code has ELEV only. State has NY only. Status Code has E only
stations <- stations %>%
      select(- c("Plus4", "Expected.Date", "EV.Other.Info","Fuel.Type.Code","State","Station.Phone","Status.Code"))
```


Charging Stations Access Days Time
```{r}
stations$hours <- ifelse(grepl("24", stations$Access.Days.Time), "24hr", "other")
pie(table(stations$hours),col=grey.colors(2))
```
     
Charging Stations Owners
```{r}
ownerlist<-data.frame(table(stations$Owner.Type.Code[stations$Owner.Type.Code!=""]))
colnames(ownerlist)<-c("Owner_Type","Freq")
ownerlist$Owner_Type<-recode(ownerlist$Owner_Type,
  "FG" = "Federal government owned",
  "J" = "Jointly owned",
  "LG"="Local government owned",
  "P"="Privately owned",
  "SG"="State government owned",
  "T"="Utility owned"
)
ggplot(ownerlist, aes(x="", y=Freq, fill=Owner_Type)) +
 geom_bar(stat="identity", width=1) +
 coord_polar("y", start=0) +
  theme_void() + ggtitle('Charging Stations Owners Type') + 
    theme(plot.title = element_text(size = 20, face = "bold"))
```

Charger types
```{r}
total_level2<-sum(na.omit(stations$EV.Level2.EVSE.Num))
total_level1<-sum(na.omit(stations$EV.Level1.EVSE.Num))
total_fast<-sum(na.omit(stations$EV.DC.Fast.Count))
tesla<-stations$EV.Connector.Types
tesla_count<-0
for (val in tesla)
{
    if(grepl(val,"TESLA")) tesla_count = tesla_count+1
}
chargertypedf <- data.frame(c("Level 1 - AC 110V","Level 2 - AC 240V", "DC Fast - DC Rapid Charging Others","DC Fast - Tesla"), c(total_level1,total_level2,total_fast-tesla_count,tesla_count))
colnames(chargertypedf)<-c("Connector_Type","Freq")
ggplot(chargertypedf, aes(x="", y=Freq, fill=Connector_Type)) +
 geom_bar(stat="identity", width=1) +
 coord_polar("y", start=0) +
  theme_void()+ ggtitle('Charger Types') + 
    theme(plot.title = element_text(size = 20, face = "bold"))
```


<p style="font-size:23px;"> EV Registration Info </p>
#Utility, original time and make may not be useful for our project.

Popular model ranking
```{r}
registration_modelname<-unite(registration_model, modelname, Make:Model, sep='-')[rev(order(registration_model$Registrations)),][-1,]
ggplot(registration_modelname, aes(x = reorder(`modelname`,-`Registrations`), y = `Registrations`)) +
  geom_col(position = "dodge")+theme(axis.text.x=element_text(angle=90, hjust=1))+labs(x="Make-Model") + 
  ggtitle('Popular model ranking') + 
  theme(plot.title = element_text(size = 20, face = "bold"))
```


County ranking
```{r}
sortedcounty<-registration_county[rev(order(registration_county$`Total EVs`)),][-1,]
ggplot(sortedcounty, aes(x = reorder(`County`,-`Total EVs`), y = `Total EVs`)) +
  geom_col(position = "dodge")+theme(axis.text.x=element_text(angle=90, hjust=1))+labs(x="County")+ 
  ggtitle('County ranking') + 
  theme(plot.title = element_text(size = 20, face = "bold"))
```

Zipcode heatmap of total EV stations
```{r}
library(choroplethrZip)
library(mapproj)

zip_group <- stations %>%
  group_by(ZIP)%>%
  summarize(Count=n())

colnames(zip_group) <- c("region", "value")
zip_group['region']=as.character(zip_group$region)

zip_choropleth(zip_group, 
               state_zoom = "new york", 
               title      = "Draw a heatmap for EV stations by zip",
               legend     = "Total EV stations") + coord_map()  

```

Zipcode heatmap of total EV Registrition
```{r}
totalcar_zip <- registration_zipcode%>%
      select(c("ZIP Code", "Total EVs"))

colnames(totalcar_zip) <- c("region", "value")

zip_choropleth(totalcar_zip, 
               state_zoom = "new york", 
               title      = "Draw a heatmap for EV registritions by zip",
               legend     = "Total EVs") + coord_map()  
```




```{r}
temp <- registration_originaltime[1:nrow(registration_originaltime)-1,]
temp  <- temp  %>%
  group_by(Year)%>%
  summarize(total_EV=sum(`Total EVs`))
ggplot(temp, aes(x=Year, y=total_EV))+geom_col()+ ggtitle('Number of Total EV by Years') + 
  xlab("Year") +
  ylab("Number of Total EV") + 
  theme(plot.title = element_text(size = 20, face = "bold"))
```


```{r}
library(lubridate)
stations_ts <- stations
stations_ts$Open.Date <- as.Date(stations_ts$Open.Date, "%m/%d/%Y")

num <- data.frame(table(factor(format(stations_ts$Open.Date,"%D"))))
num$Date <- as.Date(num$Var1,"%m/%d/%y")

num <- num[order(num$Date),]
num$cumsum <-cumsum(num$Freq)

num_temp  <- num  %>%
  group_by(year(num$Date))%>%
  summarize(total_EVsta=sum(`cumsum`))
colnames(num_temp) <- c('year','count')

ggplot(num_temp, aes(x=factor(year), y=count)) +
  geom_col() +
  ggtitle('Number of Total EV stations by Years') + 
  xlab("Year") +
  ylab("Number of Total EV stations") + 
  theme(plot.title = element_text(size = 20, face = "bold"))
```



<p style="font-size:23px;"> Time series on growth rate: EV registrations vs. EV stations</p>

```{r}
growth <- (num_temp$count-lag(num_temp$count))/lag(num_temp$count)
growth1 <- (temp$total_EV-lag(temp$total_EV))/lag(temp$total_EV)
growth1 <- c(NA, growth1,NA)
year <- c('2010','2011','2012','2013','2014','2015','2016','2017','2018','2019','2020')
growth_rate <- cbind(year, growth, growth1)
colnames(growth_rate) <- c('year','EV_sta','EV_reg')
growth_rate<- growth_rate[complete.cases(growth_rate), ] # remove NA because can't graph with NAs
tidy <- data.frame(growth_rate) %>%
  gather(key = type, value = rate, -year)
tidy$rate <- as.numeric(tidy$rate)
tidy$type <- as.factor(tidy$type)
tidy$year <- as.numeric(as.character(tidy$year))

ggplot(tidy, aes(year, rate, color = type)) + geom_point() + geom_line() + 
  ggtitle('Time Series Analysis on the Growth Rate of \nNewly Opened Stations and Newly Registered EVs \nper Year') + 
  xlab("Year") +
  ylab("Growth Rate") + 
  theme(plot.title = element_text(size = 20, face = "bold"))
```






